input {
  beats {
    port => 5044
  }
}

filter {
  grok {
    match => {
      "message" => "%{COMBINEDAPACHELOG}"
    }
  }

  # 1. Convert Apache timestamp â†’ @timestamp
  date {
    match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
    target => "@timestamp"
  }

  # 2. SQL Injection detection
  if [message] =~ "(?i)(UNION|SELECT|INSERT|UPDATE|DELETE|DROP|ALTER|--|%27|%22)" {
    mutate {
      add_tag => [ "potential_sqli" ]
    }
  }

  # 3. XSS detection
  if [message] =~ "(?i)(<script|alert\(|onerror=|onload=|%3Cscript)" {
    mutate {
      add_tag => [ "potential_xss" ]
    }
  }

  # 4. Path Traversal detection
  if [message] =~ "(?i)(\.\.\/|%2e%2e%2f|\/etc\/passwd|\/windows\/system32)" {
    mutate {
      add_tag => [ "path_traversal" ]
    }
  }

  # 5. Command Injection detection
  if [message] =~ "(?i)(;|\||&&|\$\(|`|(cat|ls|whoami|id|pwd|uname|nc|bash|sh|curl|wget))" {
    mutate {
      add_tag => [ "command_injection" ]
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "dvwa-logs-%{+YYYY.MM.dd}"
  }
}
